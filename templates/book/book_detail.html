{% extends 'base.html' %}
{% load static %}
{% block content %}

<div class="container mt-4">
  <div class="card mb-4">
    <div class="card-body">
      <h2 class="card-title">{{ Shelf.title }}</h2>
      <p class="card-text">{{ Shelf.text }}</p>
      <p class="card-subtitle mb-2 text-muted">カテゴリ: {{ Shelf.get_category_display }}</p>

      <!-- 編集・削除ボタン（ログインユーザーが投稿者なら表示） -->
      {% if user == Shelf.user %}
        <a href="{% url 'book:update-book' Shelf.id %}" class="btn btn-outline-primary btn-sm">編集</a>
        <a href="{% url 'book:delete-book' Shelf.id %}" class="btn btn-outline-danger btn-sm">削除</a>
      {% endif %}
    </div>
  </div>

  <div class="mb-3">
    ソート：
    {% if current_sort == 'new' %}
      <strong>新しい順</strong> |
      <a href="?sort=rate">評価が高い順</a>
    {% elif current_sort == 'rate' %}
      <a href="?sort=new">新しい順</a> |
      <strong>評価が高い順</strong>
    {% else %}
      <a href="?sort=new">新しい順</a> |
      <a href="?sort=rate">評価が高い順</a>
    {% endif %}
  </div>

  <h4 class="mb-3">
    レビュー一覧
    <span class="text-muted" style="font-size: 0.9em;">
      （{{ reviews.paginator.count }}件）
    </span>
  </h4>

  <!-- レビュー投稿ボタン -->
  {% if user.is_authenticated %}
    <a href="{% url 'book:create-review' Shelf.id %}" class="btn btn-outline-success mb-3">レビューを書く</a>
  {% endif %}

  {% for review in reviews %}
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">{{ review.title }}</h5>
        <h6 class="card-subtitle mb-2 text-muted">
          評価: {{ review.rate }} / 投稿者: {{ review.user.username }}
        </h6>
        <p class="text-muted mb-1" style="font-size: 0.9em;">
          投稿日: {{ review.created_at|date:"Y年m月d日 H:i" }}
        </p>
        <p class="card-text">{{ review.text }}</p>

        <!-- 参考になったボタン -->
        {% if user.is_authenticated %}
          <button
            class="btn btn-sm like-btn {% if review.is_liked %}btn-success{% else %}btn-outline-secondary{% endif %}"
            data-review-id="{{ review.id }}"
            id="like-btn-{{ review.id }}"
          >
            参考になった（<span id="like-count-{{ review.id }}">{{ review.like_count }}</span>）
          </button>

          <!-- 編集・削除ボタン（投稿者のみ） -->
          {% if user == review.user %}
            <a href="{% url 'book:update-review' review.id %}" class="btn btn-outline-primary btn-sm ms-2">レビュー編集</a>
            <a href="{% url 'book:delete-review' review.id %}"
               class="btn btn-outline-danger btn-sm ms-2">
              レビュー削除
            </a>
          {% endif %}
        {% endif %}
      </div>
    </div>
  {% empty %}
    <p>レビューはまだありません。</p>
  {% endfor %}

  <!-- ページネーション -->
  <div class="d-flex justify-content-between align-items-center mt-3">
    {% if reviews.has_previous %}
      <a href="?sort={{ current_sort }}&page={{ reviews.previous_page_number }}" class="btn btn-outline-secondary btn-sm">前へ</a>
    {% else %}
      <span></span>
    {% endif %}

    <span>ページ {{ reviews.number }} / {{ reviews.paginator.num_pages }}</span>

    {% if reviews.has_next %}
      <a href="?sort={{ current_sort }}&page={{ reviews.next_page_number }}" class="btn btn-outline-secondary btn-sm">次へ</a>
    {% else %}
      <span></span>
    {% endif %}
  </div>

  <!-- 一覧に戻るリンク -->
  <p class="mt-4">
    <a href="{% url 'book:list-book' %}" class="text-decoration-underline text-secondary">一覧に戻る</a>
  </p>
</div>

<!-- 非同期いいね処理のJavaScript -->
<script>
  document.querySelectorAll('.like-btn').forEach(button => {
    button.addEventListener('click', () => {
      const reviewId = button.dataset.reviewId;
      fetch("{% url 'book:toggle_like' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `review_id=${reviewId}`
      })
      .then(response => response.json())
      .then(data => {
        const countSpan = document.getElementById(`like-count-${reviewId}`);
        countSpan.textContent = data.like_count;
        if (data.liked) {
          button.classList.remove('btn-outline-secondary');
          button.classList.add('btn-success');
        } else {
          button.classList.remove('btn-success');
          button.classList.add('btn-outline-secondary');
        }
      });
    });
  });
</script>

{% endblock %}
