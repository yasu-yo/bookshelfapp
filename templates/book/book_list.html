{% extends "base.html" %}

{% block title %}書籍一覧{% endblock %}
{% block h1 %}書籍一覧{% endblock %}

{% block content %}

<!-- 🔍 検索・カテゴリ絞り込みフォーム -->
<form method="get" action="{% url 'book:list-book' %}" class="mb-4 d-flex gap-2">
  <input type="text" name="keyword" class="form-control w-25" placeholder="キーワード検索" value="{{ keyword }}">
  <select name="category" class="form-select w-25">
    <option value="">すべてのカテゴリ</option>
    {% for value, label in categories %}
      <option value="{{ value }}" {% if selected_category == value %}selected{% endif %}>{{ label }}</option>
    {% endfor %}
  </select>
  <button type="submit" class="btn btn-outline-success">検索</button>
</form>

<div class="row">
  <!-- 📚 登録順リスト -->
  <div class="col-md-9">
    {% for item in Shelf %}
      <div class="p-4 m-4 bg-light border border-success rounded">
        <h2 class="text-success">{{ item.title }}</h2>
        {% if item.thumbnail %}
          <div class="w-25 p-3">
            <img src="{{ item.thumbnail.url }}" class="img-thumbnail">
          </div>
        {% else %}
          <p>No thumbnail available</p>
        {% endif %}
        <h6 class="fw-light">カテゴリ：{{ item.category }}</h6>
        <div class="mt-3">
          <a href="{% url 'book:detail-book' item.pk %}" class="link-secondary link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover">詳細へ</a>
        </div>
      </div>
    {% empty %}
      <p>該当する書籍は見つかりませんでした。</p>
    {% endfor %}

    <!-- 🔁 ページネーション -->
    <div class="mt-4 d-flex justify-content-center">
      <nav aria-label="Page navigation">
        <ul class="pagination">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if keyword %}&keyword={{ keyword }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}">前へ</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">前へ</span></li>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
              <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% else %}
              <li class="page-item">
                <a class="page-link" href="?page={{ num }}{% if keyword %}&keyword={{ keyword }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}">{{ num }}</a>
              </li>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if keyword %}&keyword={{ keyword }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}">次へ</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">次へ</span></li>
          {% endif %}
        </ul>
      </nav>
    </div>
  </div>

  <!-- 🌟 レビュー順ランキング -->
  <div class="col-md-3">
    <h2>レビュー好評　TOP3</h2>
    {% for ranking_book in ranking_list %}
      <div class="p-4 m-4 bg-light border border-success rounded">
        <h3 class="text-success h5">{{ ranking_book.title }}</h3>
        <div class="w-80 p-3">
          {% if ranking_book.thumbnail %}
            <img src="{{ ranking_book.thumbnail.url }}" class="img-thumbnail">
          {% else %}
            <p>No thumbnail</p>
          {% endif %}
        </div>
        <h6>評価：{{ ranking_book.avg_rating|floatformat:2 }}点</h6>
        <a href="{% url 'book:detail-book' ranking_book.id %}" class="link-secondary link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover">詳細へ</a>
      </div>
    {% endfor %}
  </div>
</div>

{% endblock %}
